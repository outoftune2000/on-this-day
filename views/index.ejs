<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aircraft Crash Frequencies - Historical Data</title>
    <script>document.documentElement.setAttribute('data-theme',localStorage.getItem('theme')||window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');</script>
    <style>:root{--bg:#fff;--text:#212529}[data-theme=dark]{--bg:#1a1a1a;--text:#e9ecef}html,body{background:var(--bg);color:var(--text)}</style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="/styles.css" rel="stylesheet">
</head>
<body>
    <div class="theme-toggle">
        <button id="themeToggle" aria-label="Toggle dark mode">
            <i class="bi bi-moon-fill"></i>
        </button>
    </div>
    
    <div class="container py-5">
        <h1 class="text-center mb-4">Aircraft Crash Frequencies Throughout History</h1>
        
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="mb-0">Aircraft Accident Fatalities Heatmap</h3>
            </div>
            <div class="card-body">
                <div class="crash-heatmap">
                    <% 
                    const months = Array.from({length: 12}, (_, i) => i + 1);
                    const getDaysInMonth = (month) => {
                        // Use moment to get the correct number of days for each month
                        return moment().month(month-1).daysInMonth();
                    };
                    const maxDays = Math.max(...months.map(getDaysInMonth));
                    const days = Array.from({length: maxDays}, (_, i) => i + 1);
                    %>
                    
                    <div class="heatmap-legend mb-3">
                        <span class="legend-item" style="background-color: rgba(220, 53, 69, 0.1);"></span>
                        <span>0-50 deaths</span>
                        <span class="legend-item" style="background-color: rgba(220, 53, 69, 0.4);"></span>
                        <span>51-200 deaths</span>
                        <span class="legend-item" style="background-color: rgba(220, 53, 69, 0.7);"></span>
                        <span>200+ deaths</span>
                    </div>

                    <div class="text-center mb-4">
                        <button id="downloadBtn" class="btn btn-primary mb-3">
                            <i class="bi bi-download"></i> Download Fatalities Heat Map
                        </button>
                    </div>
                    <div id="heatmapContainer">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Day</th>
                                        <% months.forEach(month => { %>
                                            <th><%= moment().month(month-1).format('MMM') %></th>
                                        <% }); %>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% days.forEach(day => { %>
                                        <tr>
                                            <td><%= day %></td>
                                            <% months.forEach(month => { %>
                                                <% 
                                                const daysInMonth = getDaysInMonth(month);
                                                if (day <= daysInMonth) {
                                                    const dateStr = moment().year(2025).month(month-1).date(day).format('YYYY-MM-DD');
                                                    const dateData = frequencies.find(f => f.date === dateStr);
                                                    const deaths = dateData ? dateData.deaths : 0;
                                                    let opacity = 0;
                                                    if (deaths > 0) {
                                                        if (deaths <= 50) opacity = 0.1;
                                                        else if (deaths <= 200) opacity = 0.4;
                                                        else opacity = 0.7;
                                                    }
                                                %>
                                                    <td class="heatmap-cell" 
                                                        style="background-color: rgba(220, 53, 69, <%= opacity %>);"
                                                        data-deaths="<%= deaths %>"
                                                        data-date="<%= dateStr %>">
                                                        <%= deaths %>
                                                    </td>
                                                <% } else { %>
                                                    <td class="invalid-date"></td>
                                                <% } %>
                                            <% }); %>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <% if (crashes && crashes.length > 0) { %>
            <div class="card mb-4">
                <div class="card-header bg-danger text-white">
                    <h3 class="mb-0">Aircraft Incidents on <%= formattedDate %></h3>
                    <small>Total incidents: <%= crashes.length %> | Total fatalities: <%= crashes.reduce((sum, crash) => sum + (crash.deaths || 0), 0) %></small>
                </div>
                <div class="card-body">
                    <div class="timeline crashes">
                        <% crashes.forEach(crash => { %>
                            <div class="timeline-item crash-item">
                                <div class="timeline-badge bg-danger">
                                    <%= crash.year %>
                                </div>
                                <div class="timeline-content">
                                    <p>
                                        <%= crash.text %>
                                        <% if (crash.deaths > 0) { %>
                                            <br>
                                            <strong>Fatalities: <%= crash.deaths %></strong>
                                        <% } %>
                                        <% if (crash.pages && crash.pages.length > 0) { %>
                                            <br>
                                            <small>
                                                Read more: 
                                                <a href="<%= crash.pages[0].content_urls.desktop.page %>" target="_blank">
                                                    <%= crash.pages[0].displaytitle %>
                                                </a>
                                            </small>
                                        <% } %>
                                    </p>
                                </div>
                            </div>
                        <% }); %>
                    </div>
                </div>
            </div>
        <% } %>
    </div>

    <script>
        // Theme toggle functionality
        document.getElementById('themeToggle').addEventListener('click', function() {
            const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        });

        // Download functionality
        document.getElementById('downloadBtn').addEventListener('click', function() {
            html2canvas(document.getElementById('heatmapContainer')).then(function(canvas) {
                const link = document.createElement('a');
                link.download = 'crash-heatmap.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        });

        // Make heatmap cells clickable
        document.querySelectorAll('.heatmap-cell').forEach(cell => {
            cell.addEventListener('click', () => {
                const date = cell.getAttribute('data-date');
                window.location.href = `/?date=${date}`;
            });
        });
    </script>
</body>
</html>
